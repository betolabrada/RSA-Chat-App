<!DOCTYPE html>
<html lang="en">

<head>
  <title>Chat App</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
  <div class="container-fluid">

    <div id="userFormArea" class="row">
      <div class="col-md-12">
        <form id="userForm">
          <div class="input-group mb-3">
            <input id="userInput" autocomplete="off" type="text" class="form-control" placeholder="Nombre..."
              aria-label="Nombre..." aria-describedby="button-addon3">
            <div class="input-group-append">
              <button class="btn btn-outline-secondary" type="submit" id="button-addon3">Unirse al chat</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div id="chatArea" class="row d-none">
      <div class="col-md-4">
        <ul id="usersList"></ul>
      </div>
      <div class="col-md-8">
        <!-- aqui se forman los mensajes -->
        <ul id="messagesList"></ul>
        <div class="row">
          <div class="col-lg-6">
            <form id="messageForm">
              <div class="input-group mb-3">
                <input id="m" autocomplete="off" type="text" class="form-control" placeholder="Mensaje..."
                  aria-label="Mensaje..." aria-describedby="button-addon2">
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Enviar</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script src="/socket.io/socket.io.js"></script>
  <!-- <script src="/rsa.js"></script> -->
  <!-- <script src="/client.js"></script> -->
  <script>
    //RSA implementation
    const RSA = (() => {

      // helper functions
      function gcd(a, b) {
        return a % b === 0 ? b : gcd(b, a % b);
      }

      function swap(a, b) {
        const c = a;
        a = b;
        b = c;
      }
      // array of prime numbers
      const primeArray = (l, u) => {
        const arr = new Array(u).fill('-');
        var i = l;
        var j = l;
        var primeArray = [];
        while (i < u) {
          if (arr[i] == 'X') {
            i++;
            j = i;
            continue;
          }
          arr[i] = 'O';
          j = j + i;
          while (j <= u) {
            arr[j] = 'X';
            j += i;
          }
          i++;
          j = i;
        }

        for (var i = 0; i < arr.length; i++) {
          if (arr[i] == 'O') {
            primeArray.push(i);
          }
        }
        return primeArray;
      }
      const primeGen = () => {
        const primes = primeArray(2, 100);
        var pdx = Math.floor(Math.random() * primes.length);
        var qdx = Math.floor(Math.random() * primes.length);
        while (pdx == qdx) {
          qdx = Math.random() * 100;
        }
        return {
          p: primes[pdx],
          q: primes[qdx]
        }
      }
      const generateKeys = () => {
        // random prime numbers
        const rpn = primeGen();
        // public key: n, e
        const n = rpn.p * rpn.q;
        const phi = (rpn.p - 1) * (rpn.q - 1);
        var e;
        for (e = 2; e < phi; e++) {
          if (gcd(phi, e) == 1) {
            break;
          }
        }

        // private key
        const d = (2 * phi + 1) / e;

        return {
          publicKey: {
            n: n,
            e: e
          },
          privateKey: {
            n: n,
            d: d
          }
        }


      }

      const encrypt = (message, publicKey) => { }

      const decrypt = (message, privateKey) => { }

      return {
        generateKeys,
        encrypt,
        decrypt
      }

    })()

    
    // new socket client
    const socket = io();

    // generate user keys
    const userKeys = RSA.generateKeys();

    // DOM elements
    const chatArea = document.querySelector('#chatArea');
    const messageForm = document.querySelector('#messageForm');
    const chatMessage = document.querySelector('#m');
    const messagesList = document.querySelector('#messagesList');

    const userFormArea = document.querySelector('#userFormArea')
    const userForm = document.querySelector('#userForm');
    const userInput = document.querySelector('#userInput');
    const usersList = document.querySelector('#usersList');

    // helper function to add list node to DOM
    const newListNode = function (list, content) {
      const element = document.createElement('li');
      element.classList.add("list-group-item");
      element.appendChild(document.createTextNode(content));
      list.appendChild(element);
    }

    // send messages to server
    messageForm.addEventListener('submit', function (e) {
      e.preventDefault();
      // event: chat message, send encrypted data to server
      socket.emit('chat message', chatMessage.value);
      chatMessage.value = '';
      return false;
    });
    
    socket.on('chat message', function (msg) {
      newListNode(messagesList, msg.username + ': ' + msg.message);
    });

    userForm.addEventListener('submit', function (e) {
      e.preventDefault();
      socket.emit('new user', {
        username: userInput.value,
        publicKey: userKeys.publicKey
      }, function (data) {
        if (data) {
          userFormArea.classList.add('d-none');
          if (chatArea.classList.contains('d-none')) {
            chatArea.classList.remove('d-none');
          }
        }
      });
      userInput.value = '';
      return false;
    });

    const removeUsersList = () => usersList.innerHTML = '';

    socket.on('get users', function (data) {
      console.log(data);
      removeUsersList();
      const headerListNode = document.createElement('li');
      headerListNode.classList.add("list-group-item", "list-group-item-dark");
      headerListNode.appendChild(document.createTextNode("Personas en el chat"));
      usersList.appendChild(headerListNode);
      for (var i = 0; i < data.length; i++) {
        newListNode(usersList, data[i].username);
      }
    });

    socket.on('send key', function (data) {

    });
  </script>

</body>

</html>